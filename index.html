<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta http-equiv="X-UA-Compatible" content="IE=edge">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>EPSMap</title>
    
    <link rel="stylesheet" href="media/bootstrap-v4.6.1/bootstrap.min.css">
    <link rel="stylesheet" href="media/fontawesome-4.7.0/font-awesome.min.css">
    <link rel="stylesheet" href="media/virtualselect-1.0.26/virtual-select.min.css">
    <link rel="stylesheet" href="media/tooltip-1.0.16/tooltip.min.css">
    <link rel="stylesheet" href="media/styles.css">
</head>
<body>
    <header>
        <div class="header-title">
            <h1>EPSMap</h1>
            <h2>Sistema de navegació intern pels edificis de la EPS</h2>
        </div>
    </header>
    <div class="content">
        <div class="main-title">
            <h3>Selecciona la teva destinació</h3>
        </div>
        <div>
            <div class="search-option-wrapper">
                <div style="display: flex;">
                    <input type="checkbox" style="margin-top: 7px; margin-right: 5px;" class="" id="department" name="department"/>
                    <label class="toggle" for="department">Department</label>
                </div>
                <div style="display: flex;">
                    <input type="checkbox" style="margin-top: 7px; margin-right: 5px;" class="" id="destination_zone" name="destination_zone"/>
                    <label class="toggle" for="destination_zone">Destination Zone</label>
                </div>
                <div style="display: flex;">
                    <input type="checkbox" style="margin-top: 7px; margin-right: 5px;" class="" id="people" name="people"/>
                    <label class="toggle" for="people">People</label>
                </div>
                <div style="display: flex;">
                    <input type="checkbox" style="margin-top: 7px; margin-right: 5px;" class="" id="space" name="space"/>
                    <label class="toggle" for="space">Space</label>
                </div>
                <!-- <label class="toggle" for="department">
                    <input type="checkbox" class="toggle__input" id="department" name="department"/>
                    <span class="toggle-track">
                        <span class="toggle-indicator"></span>
                    </span>
                    Department
                </label>
                <label class="toggle" for="destination_zone">
                    <input type="checkbox" class="toggle__input" id="destination_zone" name="destination_zone"/>
                    <span class="toggle-track">
                        <span class="toggle-indicator"></span>
                    </span>
                    Destination Zone
                </label>
                <label class="toggle" for="people">
                    <input type="checkbox" class="toggle__input" id="people" name="people"/>
                    <span class="toggle-track">
                        <span class="toggle-indicator"></span>
                    </span>
                    People
                </label>
                <label class="toggle" for="space">
                    <input type="checkbox" class="toggle__input" id="space" name="space"/>
                    <span class="toggle-track">
                        <span class="toggle-indicator"></span>
                    </span>
                    Space
                </label> -->
            </div>
            <!-- <div class="searcher-wrapper">
                <div id="searcher"></div>
                <div>
                    <button class="searcher-button btn btn-primary btn-sm" disabled>Search</button>
                </div>
            </div> -->

            <!-- <br><br><br> -->
            <div id="vs-searcher"></div>
            <div id="path-instructions"></div>
        </div>
    </div>
    <script src="media/jquery-3.6.0/jquery-3.6.0.min.js"></script>
    <script src="media/bootstrap-v4.6.1/bootstrap.bundle.min.js"></script>
    <script src="media/virtualselect-1.0.26/virtual-select.min.js"></script>
    <script src="media/tooltip-1.0.16/tooltip.min.js"></script>
    <!-- <script src="media/scripts.js"></script> -->
    <script>
        const VirtualSelect_Searcher = function(config){

            if(!config.main) throw new Error("Main HTML node to attach the searcher not given");
            if($(config.main).length == 0) throw new Error("The given HTML node is empty");
            if(!config.capture_point_id) throw new Error("Capture point ID for the search was not given");
            if(config.capture_point_id == NaN) throw new Error("Capture point ID must be a number");
            const capture_point_id = config.capture_point_id;
            let search_timeout = null;

            // If the variable starts with "$", that means it holds a jQuery object

            let $button = $("<button/>", { // Button to search
                    "class": "searcher-button btn btn-primary btn-sm",
                    "disabled": 1
                }).text("Search"),
                
                $vs = $("<div/>", { // Div where the vs-comp will be placed
                    "id": randomID(8)
                }),

                $wrapper = $(config.main).addClass("searcher-wrapper").append($vs, $("<div/>").append($button)), // Place everything inside the wrapper, the button is placed inside another div

                vs = VirtualSelect.init({ // Once everything is in the DOM initialize the vs-comp
                    ele: "#"+$vs.attr("id"),
                    search: true,
                    markSearchResults: true,
                    showSelectedOptionsFirst: true,
                    onServerSearch: function(value, virtualSelect){
                        clearTimeout(search_timeout);
                        search_timeout = setTimeout(() => {
                            searchValue(value).then(response => updateSelect(response, virtualSelect)).catch(jqXHR => console.error(jqXHR));
                        }, 200);
                    }
                });


            // Different checkboxes for different search values to include
            let checkbox_departments = (config.departments && config.departments.checkbox) ? $(config.departments.checkbox) : null,
                checkbox_destination_zones = (config.destination_zones && config.destination_zones.checkbox) ? $(config.destination_zones.checkbox) : null,
                checkbox_people = (config.people && config.people.checkbox) ? $(config.people.checkbox) : null,
                checkbox_spaces = (config.spaces && config.spaces.checkbox) ? $(config.spaces.checkbox) : null;
            
            // List with the checkboxes the user gave us
            const active_checkboxes = [];
            checkbox_departments && active_checkboxes.push(checkbox_departments);
            checkbox_destination_zones && active_checkboxes.push(checkbox_destination_zones);
            checkbox_people && active_checkboxes.push(checkbox_people);
            checkbox_spaces && active_checkboxes.push(checkbox_spaces);

            /**
             * Search a value in the database
             * @param {String} value Value to search
             * 
             * @returns {Promise} On resolve returns the list of places found, on reject returns the jqXHR error object
             */
            async function searchValue(value){
                return new Promise((resolve, reject) => {
                    const include_departments =  (checkbox_departments && checkbox_departments.is(":checked")) ? 1 : 0,
                        include_destination_zones = (checkbox_destination_zones && checkbox_destination_zones.is(":checked")) ? 1 : 0,
                        include_people = (checkbox_people && checkbox_people.is(":checked")) ? 1 : 0,
                        include_spaces = (checkbox_spaces && checkbox_spaces.is(":checked")) ? 1 : 0;
                    
                    if(!include_departments && !include_destination_zones && !include_people && !include_spaces) resolve([]);
    
                    $.ajax({
                        type: "GET",
                        data: {
                            "text_search": value,
                            "limit": 20,
                            "department": include_departments,
                            "destination_zone": include_destination_zones,
                            "people": include_people,
                            "space": include_spaces
                        },
                        url: "actions/search.php",
                        success: response => resolve(response),
                        error: jqXHR => reject(jqXHR)
                    })
                })
            }

            async function searchPathTo(destination_node_id){
                return new Promise((resolve, reject) => {
                    $.ajax({
                        type: "GET",
                        data: {
                            capture_point_id: capture_point_id,
                            destination_node_id: destination_node_id
                        },
                        url: "actions/get_path.php",
                        success: response => resolve(response),
                        error: jqXHR => reject(jqXHR)
                    })
                });
            }
    
            /**
             * Update the virtualSelect
             * 
             * @param {Array} new_values An array with the new values returned by the server
             * 
             * @returns {void}
             */
            function updateSelect(new_values){
                // The values for the VirtualSelect have a preappended random value to avoid problems when two differents objects point to the same final node id
                // The values need to be unique, and without the random value, they wouldn't be unique, you can get the actual ID with value.split("-")[1]
                let option_groups = [];
                if(checkbox_departments && new_values.department && new_values.department.length > 0){
                    let options = {
                        "label": "Departments",
                        "options": []
                    }
                    options.options.push(...new_values.department.map(elem => {return {"label": elem.name, "value": randomID(3)+"-"+elem.id}}))
                    option_groups.push(options);
                }
                if(checkbox_destination_zones && new_values.destination_zone && new_values.destination_zone.length > 0){
                    let options = {
                        "label": "Destination Zones",
                        "options": []
                    }
                    options.options.push(...new_values.destination_zone.map(elem => {return {"label": elem.name, "value": randomID(3)+"-"+elem.main_node.id}}))
                    option_groups.push(options);
                }
                if(checkbox_spaces && new_values.space && new_values.space.length > 0){
                    let options = {
                        "label": "Spaces",
                        "options": []
                    }
                    options.options.push(...new_values.space.map(elem => {return {"label": elem.name, "value": randomID(3)+"-"+elem.destination_zone.main_node}}))
                    option_groups.push(options);
                }
                
                if(checkbox_people && new_values.people && new_values.people.length > 0){
                    let options = {
                        "label": "People",
                        "options": []
                    }
                    options.options.push(...new_values.people.map(elem => {return {"label": elem.name, "value": randomID(3)+"-"+elem.id}}))
                    option_groups.push(options);
                }
    
                vs.setServerOptions(option_groups);
            }

            /**
             * Generate a random string
             */
            function randomID(length) {
                let result           = '',
                    letters          = 'ABCDEFGHIJKLMNOPQRSTUVWXYZabcdefghijklmnopqrstuvwxyz',
                    numbers          = '0123456789',
                    characters       = letters+numbers,
                    charactersLength = characters.length;

                result += letters.charAt(Math.floor(Math.random() * letters.length)); // Force the first to be a letter, if the first is a number JS will throw an error

                for ( let i = 1; i < length; i++ ) {
                    result += characters.charAt(Math.floor(Math.random() * charactersLength));
                }

                return result;
            }
            
            // On change the status of any of the given checkboxes perform an empty search
            active_checkboxes.forEach(elem => {
                elem.on('change', event => { 
                    searchValue("").then(response => updateSelect(response, vs)).catch(jqXHR => console.error(jqXHR));
                });
            })
    
            // When a value is selected enable the button to search
            $vs.on('change', event => {
                if($vs.val() != "") $button.prop("disabled", 0);
                else $button.prop("disabled", 1);
            });

            $button.on('click', event => {
                const final_node_id = $vs.val().split("-")[1];
                console.log(final_node_id);
                searchPathTo(final_node_id).then(path => config.onSelectDestination(final_node_id, path.instructions, path.total_cost, path.initial_turn)).catch(jqXHR => console.error(jqXHR));
            });
        }



        const searchParams = (new URL(window.location.href)).searchParams;
        const capture_point_id = parseInt(searchParams.get("cp_id")) || 1;
        const language = searchParams.get("lang") || "es";


        VirtualSelect_Searcher({
            main: $("#vs-searcher"),
            departments: {
                checkbox: $("input[type=checkbox][name=department]")
            },
            destination_zones: {
                checkbox: $("input[type=checkbox][name=destination_zone]")
            },
            people: {
                checkbox: $("input[type=checkbox][name=people]")
            },
            spaces: {
                checkbox: $("input[type=checkbox][name=space]")
            },
            capture_point_id: capture_point_id,
            language: "es",
            onSelectDestination: (destination, path, total_cost, initial_turn=null) => {
                let path_instructions = $("#path-instructions");
                path_instructions.empty();
                if(initial_turn){
                    path_instructions.append($("<div/>", {
                            class: "instruction-wrapper"
                        }).append($("<div/>", { class: "instruction-text" }).text("Initial turn: " + initial_turn))
                    );
                }
                path.forEach(edge => {
                    const from_edge = edge.from;
                    const to_edge = edge.to;
                    const instruction_translation = edge.instruction_translation;
                    const has_image = edge.has_image;
                    const instruction_image = has_image ? $("<div/>", {
                        class: "instruction-image"
                    }).append($("<img/>", {
                        src: "actions/getInstructionImage.php?initial_edge_id="+from_edge.id+"&destination_edge_id="+to_edge.id
                    })) : null;

                    const instruction_text = $("<div/>", {
                        class: "instruction-text"
                    }).text(instruction_translation.text);

                    
                    const instruction_wrapper = ($("<div/>", {
                            class: "instruction-wrapper"
                        }).append(instruction_image, instruction_text)
                    );

                    path_instructions.append(instruction_wrapper);
                })
            }
        })
    </script>
</body>
</html>